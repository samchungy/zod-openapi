# zod-openapi v5 📚

This guide explains the key changes between zod-openapi v4 and v5.

## 🔄 Differences from v4

### 🛠️ Runtime Changes

✨ **Removed runtime monkey-patching**

- `extendZodWithOpenApi()` and `import zod-openapi/extend` have been removed
- Zod v4 introduces a native `.meta()` method for adding OpenAPI metadata directly which makes `.openapi()` redundant

You can now declare `zod-openapi` as a dev dependency instead of a runtime dependency if you create schemas at build time

### 📊 Schema Generation Changes

🆕 **OpenAPI version requirements**

- OpenAPI 3.1.0 is now the minimum required version
- Support for OpenAPI 3.1.1 has been added

🚀 **Performance improvements**

- Internal schema generation replaced with Zod's native `toJSONSchema()` method
- This halves the size of the library and should deliver better performance

⚡ **Minor change:** `.extend()` behavior

- No longer creates an embedded `allOf` referenced schema
- This functionality would need to be contributed to the main Zod library if desired

### 🔧 Zod OpenAPI Options

#### Renamed Options

- `ref` → `id`
  ```diff
  - .openapi({ ref: 'MySchema' })
  + .meta({ id: 'MySchema' })
  ```

#### Removed Options

- `unionOneOf`
- `enforceDiscriminatedUnionComponents`
- `defaultDateSchema`

#### New Override System

**Direct property setting:**

This is native to Zod v4 and allows you to set properties directly on the schema.

```ts
z.date().meta({
  type: 'string',
  format: 'date-time',
});
```

> **Note:** Zod's native type representation takes precedence over the fields set in the `meta()` method.
> You can provide an `override` object or function to override this behavior.

**Simple example:**

```ts
z.string().meta({
  override: {
    type: number,
  },
});
```

**Advanced customization with functions:**

```ts
// Example: achieving unionOneOf behavior
z.union([z.string(), z.number()]).meta({
  override: ({ jsonSchema }) => {
    jsonSchema.oneOf = jsonSchema.anyOf;
    delete jsonSchema.anyOf;
  },
});
```

**Global overrides:**

```ts
import { createDocument } from 'zod-openapi';

createDocument(document, {
  override: ({ jsonSchema, zodSchema, io }) => {
    const def = zodSchema._zod.def;
    if (def.type === 'date' && io === 'output') {
      jsonSchema.type = 'string';
      jsonSchema.format = 'date-time';
    }
    if (def.type === 'union') {
      jsonSchema.oneOf = jsonSchema.anyOf;
      delete jsonSchema.anyOf;
    }
  },
});
```

> **Important:** Only an `override` function can be provided in `CreateDocumentOptions`. Schema-level `override` will always run after the global function.

**Other changes:**

⚙️ **`effectType` removed**

> Transforms are not introspectable. `effectType` was introduced to attempt to address this and to try and keep the the transform locked to the same type as the input schema.
> For transform operations, use Zod's native [`.overwrite()`](https://zod.dev/v4?id=overwrite) method, wrap your schema in a `.pipe()`, or declare a manual type.

🔄 **`refType` → `unusedIO`**
